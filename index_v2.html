<!DOCTYPE html>
<html lang="mn">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Эхлэл 1 — 몽골어 클릭 사전 (HTML만, v2)</title>
<style>
  :root {
    --bg: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --brand: #16a34a; /* green to distinguish v2 */
    --panel: #f8fafc;
    --chip: #ecfdf5;
    --chip-border: #bbf7d0;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; padding: 16px 16px 160px;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Apple SD Gothic Neo", "Malgun Gothic", "Helvetica Neue", Arial, "Noto Color Emoji", "Segoe UI Emoji", sans-serif;
    line-height: 1.8; color: var(--text); background: var(--bg);
  }
  h1 { margin: 0 0 4px; font-size: 22px; }
  .sub { margin: 0 0 12px; color: var(--muted); font-size: 13px; }
  #text { white-space: pre-wrap; font-size: 18px; }
  .word {
    cursor: pointer; padding: 2px 4px; border-radius: 6px;
    transition: background .12s ease;
  }
  .word:hover { background: #eef; }
  .sel { background: #e9ffee; outline: 1px solid #bbf7d0; }
  #toolbar {
    display:flex; gap:8px; align-items:center; flex-wrap: wrap;
    margin: 8px 0 14px;
  }
  .btn {
    appearance:none; border:1px solid #d1d5db; background:#fff; color:#111;
    padding:6px 10px; border-radius: 999px; font-size: 13px; cursor:pointer;
  }
  .btn:active { transform: translateY(1px); }
  .toggle { display:flex; align-items:center; gap:6px; font-size: 13px; color: var(--muted); }
  #panel {
    position: fixed; left: 0; right: 0; bottom: 0;
    border-top: 1px solid #e5e7eb; background: var(--panel);
    padding: 12px 16px; box-shadow: 0 -6px 18px rgba(0,0,0,.06);
  }
  #panel .w { font-weight: 800; font-size: 18px; }
  #chips { display:flex; gap:8px; flex-wrap:wrap; margin: 8px 0 0; }
  .chip {
    font-size: 12px; background: var(--chip); color:#065f46; border:1px solid var(--chip-border);
    padding: 4px 8px; border-radius: 999px;
  }
  #defs { margin-top: 6px; }
  #defs .def { padding: 3px 0; }
  #meta { margin-top: 8px; font-size: 12px; color: var(--muted); }
  .badge { font-size: 11px; background: #dcfce7; color:#065f46; border: 1px solid #86efac; padding: 2px 6px; border-radius: 999px; }
  footer { margin-top: 10px; font-size: 11px; color:#94a3b8; }
</style>
</head>
<body data-version="v2">
  <h1>Эхлэл 1 — АБ2013 <span class="badge">v2</span></h1>
  <p class="sub">단어를 탭하면 아래에 <strong>뜻</strong>이 바로 뜬다. (백엔드 없음 / Wiktionary API / 로컬 캐시 기본 24시간)</p>

  <div id="toolbar">
    <label class="toggle">
      <input type="checkbox" id="useCache" checked />
      캐시 사용(24시간)
    </label>
    <button id="forceRefresh" class="btn">선택 단어 다시 조회</button>
    <button id="clearCache" class="btn">캐시 모두 삭제</button>
  </div>

  <div id="text"></div>

  <div id="panel" hidden>
    <div class="w" id="w"></div>
    <div id="chips">
      <span class="chip" id="pos" style="display:none"></span>
      <span class="chip" id="lemma" style="display:none"></span>
      <span class="chip">출처: Wiktionary</span>
    </div>
    <div id="defs"></div>
    <div id="meta"></div>
  </div>

  <footer>Version: <strong>2025-08-10 v2</strong> · 브라우저 캐시/로컬스토리지 영향 받음</footer>

<script>
/* ------------------------- 설정 ------------------------- */
const CACHE_HOURS = 24; // 바꾸고 싶으면 여기 조절
const CACHE_KEY_PREFIX = "mnv2:"; // v2부터 키 프리픽스 변경(이전 캐시와 충돌 방지)
const CYRILLIC = /[\\u0400-\\u04FF]/;
const WORD_RE = /([\\u0400-\\u04FF]+)|(\\s+|[^\\u0400-\\u04FF]+)/g;

/* ------------------------- 본문 ------------------------- */
const textData = `[1] Эхэнд Бурхан тэнгэр ба газрыг бүтээжээ. [2] Газар нь хэлбэржээгүй, хоосон төдийгүй оёоргүй гүний гадаргууд харанхуй бүрхэж, Бурханы Сүнс усны мандал дээгүүр элин хальж байлаа. [3] Тэгэхэд Бурхан —Гэрэл бий болтугай! гэж айлдсанд гэрэл бий болов. [4] Гэрэл сайн болсныг Бурхан харж, Бурхан гэрлийг харанхуйгаас салгажээ. [5] Бурхан гэрлийг өдөр гэж нэрлээд, харанхуйг шөнө гэж нэрлэлээ. Ийн үдэш болоод, өглөө болсон нь анхны өдөр. [6] Бурхан —Усны дундуур огторгуй байж, ийнхүү усыг уснаас салгатугай! гэж айлдав. [7] Бурхан ингэж огторгуйг бий болгоод, огторгуйн дээрх уснаас огторгуйн доорх усыг салгасанд ёсоор болов. [8] Бурхан огторгуйг тэнгэр гэж нэрлэжээ. Үдэш болоод, өглөө болсон нь хоёр дахь өдөр. [9] Бурхан —Тэнгэрийн доорх ус нэг дор хуримтлагдаж, ийн хуурай газар ил гартугай! гэсэнд ёсоор болжээ. [10] Бурхан хуурайг нь газар, хуримтлагдсан усыг нь далай гэж нэрлэв. Эдгээр нь сайн болсныг Бурхан харлаа. [11] Ингээд Бурхан —Газар нь ургамал ногоог буюу үрлэгч өвс ногоо, доторх үрээ газарт гөвдөг үр жимст модыг төрөл төрлөөр нь ургуултугай! гэж айлдсанд ёсоор болжээ. [12] Газар нь ийнхүү ургамал ногоог буюу үрлэгч өвс ногоо, доторх үрээ газарт гөвдөг үр жимст модыг төрөл төрлөөр нь гаргав. Эдгээр нь сайн болсныг Бурхан харлаа. [13] Үдэш болоод, өглөө болсон нь гурав дахь өдөр. [14] Тэгээд Бурхан —Өдрийг шөнөөс салгахын тулд тэнгэр огторгуйд гэрэлтүүлэгчид байх болтугай! Эдгээр нь тэмдэг, улирал, өдөр, жилийн тулд байг. [15] Тэнгэр огторгуйд гэрэлтүүлэгчид байж газар дэлхийг гийгүүлэг! гэж айлдсанд ёсоор болжээ. [16] Бурхан өдрийг захируулахаар нэг томхон гэрэлтүүлэгч, шөнийг захируулахаар арай багавтар гэрэлтүүлэгч, ийм хоёр том гэрэлтүүлэгчийг мөн оддыг бий болгов. [17] Бурхан тэдгээрээр газар дэлхийг гэрэлтүүлэхээр тэнгэр огторгуйд тавьсан нь [18] өдөр, шөнө хоёрыг захируулах бас гэрлийг харанхуйгаас салгахын тулд ажгуу. Эдгээр нь сайн болсныг Бурхан харлаа. [19] Үдэш болоод, өглөө болсон нь дөрөв дэх өдөр. [20] Бурхан —Шунган шумбагч амьд биетээр уснууд цалгилтугай, бас шувууд газар дэлхий дээгүүр, тэнгэр огторгуйн мандалд нистүгэй! гэж айлдав. [21] Ийнхүү Бурхан далай тэнгисийн аварга том амьтад ба уснаа шунган шумбагч амьд биетийг төрөл төрлөөр нь бас аливаа жигүүртэн шувуудыг төрөл төрлөөр нь бүтээв. Эдгээр нь сайн болсныг Бурхан харлаа. [22] Бурхан тэднийг ерөөн —Үржиж, олширцгоог! Далай тэнгисийн усанд дүүрцгээг! Шувууд ч газар дэлхийд олширцгоог! хэмээв. [23] Үдэш болоод, өглөө болсон нь тав дахь өдөр. [24] Бурхан —Газар дэлхий амьд биетийг төрөл төрлөөр нь буюу мал адгуус, мөлхөгчид, газрын зэрлэг амьтдыг төрөл төрлөөр нь гаргатугай! гэж айлдсанд ёсоор болжээ. [25] Бурхан ийнхүү газрын зэрлэг амьтдыг төрөл төрлөөр нь, мал адгуусыг төрөл төрлөөр нь, газраар мөлхөгч бүгдийг төрөл төрлөөр нь бий болгов. Эдгээр нь сайн болсныг Бурхан харлаа. [26] Тэгээд Бурхан —Бид дүр төрхийнхөө дагуу бидэнтэй адилхан хүнийг буй болгоё. Тэгээд тэднээр далайн загас, огторгуйн шувууд, мал адгуус, бүх газар дэлхий, газраар мөлхдөг мөлхөгч бүгдийг захируулъя гэж айлдав. [27] Ийнхүү Бурхан Өөрийнхөө дүр төрхөөр хүнийг бүтээж, Бурханы дүр төрхөөр бүтээхдээ эр эмээр нь бүтээжээ. [28] Бурхан тэднийг ерөөж —Үржиж, олширцгоог! Газар дэлхийг дүүргэж, түүнийг эзэмшицгээг! Далайн загас, огторгуйн шувууд хийгээд газар дээр хөлхөгч амьтан бүхнийг захирцгааг! гэв. [29] Бурхан —Үзэгтүн, газрын гадарга дээрх үрт өвс ногоо бүрийг, үрээ гөвдөг үр жимст мод бүгдийг Би та нарт өгнө. Тэр бүхэн та нарын хоол хүнс болно. [30] Газар дэлхийн зэрлэг амьтан бүхэнд, огторгуйн шувуу бүхэнд, газраар мөлхөгч бүхэнд, амьтай амьсгалтай бүхэнд өвс ногоо бүгдийг хоол хүнс болгож өгье гэсэнд ёсоор болжээ. [31] Өөрийнх нь буй болгосон бүгд нэн сайн болсныг Бурхан харлаа. Үдэш болоод, өглөө болсон нь зургаа дахь өдөр.`;

/* ------------------------- 렌더링 ------------------------- */
const textEl = document.getElementById("text");
let currentSel = null;

function renderText() {
  const frag = document.createDocumentFragment();
  const it = textData.matchAll(WORD_RE);
  for (const m of it) {
    const w = m[1];
    const other = m[2];
    if (w) {
      const span = document.createElement("span");
      span.textContent = w;
      span.className = "word";
      span.dataset.raw = w;
      span.addEventListener("click", () => onWordClick(span));
      frag.appendChild(span);
    } else {
      frag.appendChild(document.createTextNode(other));
    }
  }
  textEl.innerHTML = "";
  textEl.appendChild(frag);
}
renderText();

/* ------------------------- 조회/캐시/렌더 ------------------------- */
const useCacheEl = document.getElementById("useCache");
const forceBtn = document.getElementById("forceRefresh");
const clearBtn = document.getElementById("clearCache");

forceBtn.onclick = () => {
  if (!currentSel) return;
  const word = (currentSel.dataset.raw || "").trim();
  // 강제 재조회: 캐시 삭제 후 조회
  localStorage.removeItem(cacheKey(word));
  onWordClick(currentSel, { force: true });
};
clearBtn.onclick = () => {
  Object.keys(localStorage)
    .filter(k => k.startsWith(CACHE_KEY_PREFIX))
    .forEach(k => localStorage.removeItem(k));
  alert("캐시를 모두 삭제했어!");
};

function cacheKey(w){ return `${CACHE_KEY_PREFIX}${w.toLowerCase()}`; }

async function onWordClick(el, opts={}){
  const word = normalize(el.dataset.raw || "");
  if (!word || !CYRILLIC.test(word)) return;

  // 선택 하이라이트
  if (currentSel) currentSel.classList.remove("sel");
  el.classList.add("sel");
  currentSel = el;

  const key = cacheKey(word);
  const cached = JSON.parse(localStorage.getItem(key) || "null");
  const cacheEnabled = useCacheEl.checked;

  if (cacheEnabled && !opts.force && cached && Date.now() - cached.t < CACHE_HOURS*3600*1000) {
    return renderDefs(word, cached.data);
  }

  // Wiktionary MN → EN#Mongolian 순서 시도
  let data = await fetchWikt(
    `https://mn.wiktionary.org/w/api.php?action=parse&prop=text&page=${encodeURIComponent(word)}&format=json&origin=*`,
    "Wiktionary (mn)",
    `https://mn.wiktionary.org/wiki/${encodeURIComponent(word)}`
  );
  if (!data || (data.senses||[]).length === 0) {
    data = await fetchWikt(
      `https://en.wiktionary.org/w/api.php?action=parse&prop=text&page=${encodeURIComponent(word)}&format=json&origin=*`,
      "Wiktionary (en)#Mongolian",
      `https://en.wiktionary.org/wiki/${encodeURIComponent(word)}#Mongolian`,
      true
    );
  }
  if (cacheEnabled) {
    localStorage.setItem(key, JSON.stringify({ t: Date.now(), data }));
  }
  renderDefs(word, data);
}

async function fetchWikt(apiUrl, sourceName, sourceUrl, needMongolian=false){
  try{
    // cache: 'no-store'로 네트워크 강제 (브라우저 캐시 우회)
    const r = await fetch(apiUrl, { cache: 'no-store' });
    const j = await r.json();
    const html = j?.parse?.text?.["*"] || "";
    if (!html) return { lemmas:[], pos:null, senses:[], source:{name:sourceName,url:sourceUrl} };

    // 섹션 선택
    let section = html;
    if (needMongolian) {
      const parts = html.split(/<span[^>]*id="Mongolian"[^>]*>/i);
      section = parts[1] || html;
    }

    // POS 추출(간단)
    let pos = null;
    const posMatch = section.match(/<span class="mw-headline"[^>]*>(Noun|Verb|Adjective|Adverb|Pronoun|Numeral|Particle|Conjunction|Preposition)<\/span>/i);
    if (posMatch) pos = posMatch[1];

    // 정의: Mongolian 섹션 첫 번째 <ol>/<ul> 안의 <li> 우선 추출 시도
    let senses = [];
    const listMatch = section.match(/<(ol|ul)[^>]*>([\s\S]*?)<\/\1>/i);
    if (listMatch) {
      senses = [...listMatch[2].matchAll(/<li>(.*?)<\/li>/g)]
        .map(m=>cleanHtml(m[1]))
        .filter(Boolean);
    }
    // 보조 추출(없으면 전체에서 li 수집)
    if (senses.length === 0) {
      senses = [...section.matchAll(/<li>(.*?)<\/li>/g)]
        .map(m=>cleanHtml(m[1]))
        .filter(Boolean);
    }
    senses = senses.slice(0, 10);

    const lemmas = [ (j?.parse?.title || "").trim() ].filter(Boolean);

    return { lemmas, pos, senses, source:{name:sourceName, url:sourceUrl} };
  }catch(e){
    return { lemmas:[], pos:null, senses:[], source:{name:sourceName,url:sourceUrl}, error: String(e) };
  }
}

function normalize(token){
  return token.replace(/^[—–\-–—.,!?;:()\[\]«»"“”‘’]+|[—–\-–—.,!?;:()\[\]«»"“”‘’]+$/g,"").trim();
}
function cleanHtml(s){
  return s.replace(/<[^>]+>/g,'').replace(/\s+/g,' ').trim();
}

/* ------------------------- 렌더 ------------------------- */
const panelEl = document.getElementById("panel");
const wEl = document.getElementById("w");
const posEl = document.getElementById("pos");
const lemmaEl = document.getElementById("lemma");
const defsEl = document.getElementById("defs");
const metaEl = document.getElementById("meta");

function renderDefs(originalWord, payload){
  panelEl.hidden = false;
  const lemma = (payload?.lemmas && payload.lemmas[0]) || originalWord;

  wEl.textContent = lemma;
  if (payload?.pos) { posEl.textContent = payload.pos; posEl.style.display = "inline-block"; }
  else { posEl.style.display = "none"; }
  if (lemma && lemma !== originalWord) { lemmaEl.textContent = `원형: ${lemma}`; lemmaEl.style.display = "inline-block"; }
  else { lemmaEl.style.display = "none"; }

  defsEl.innerHTML = (payload?.senses||[]).length
    ? payload.senses.map(s=>`<div class="def">• ${escapeHtml(s)}</div>`).join("")
    : `<div class="def">뜻을 못 찾았어 😢 (출처 페이지에서 직접 확인해봐)</div>`;

  const src = payload?.source;
  const when = new Date().toLocaleString();
  metaEl.innerHTML = src
    ? `출처: <a href="${src.url}" target="_blank" rel="noopener">${escapeHtml(src.name)}</a> · 조회: ${when}`
    : `조회: ${when}`;
}

function escapeHtml(s){
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
}
</script>
</body>
</html>
